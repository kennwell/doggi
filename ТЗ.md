### Техническое задание (ТЗ) на разработку CLI-утилиты "doggi"

#### 1. Общее описание
Разработать командную строку (CLI) утилиту под названием "doggi" для macOS, аналогичную инструменту "doggo". Утилита предназначена для разрешения DNS-запросов с обязательной поддержкой DNS over TLS (DoT) и DNS over HTTPS (DoH). По умолчанию используется сервер tls://1.1.1.1. Утилита должна выводить IPv4 и IPv6 адреса для указанного домена, а также геолокационные данные (код страны, город на английском, ASN, ASN-name) для каждого IP.

Утилита должна быть простой в использовании, работать из терминала на Mac (с M3 чипом и 8 ГБ RAM), и быть написана на Python для быстрой разработки и совместимости с существующим стеком (venv, pip). Все запросы выполняются только к одному DNS-серверу (указанному или по умолчанию). [1][2]

#### 2. Функциональные требования
- **Парсинг аргументов**:
  - Обязательный параметр: домен (например, "ya.ru").
  - Опциональный параметр: DNS-сервер (по умолчанию tls://1.1.1.1). Поддержка формата "@<IP>[:порт]" для DoT/DoH (например, "@8.8.8.8").
  - Если сервер не указан, использовать tls://1.1.1.1.
  - Поддержка DoH (DNS over HTTPS) обязательно для серверов вроде https://dns.google/resolve.
  - Примеры dns серверов:
    - https://nl2.ogne.top:8443/dns-query (поддерживаются URL DoH формата `https://.../dns-query`)
    - tls://nl2.ogne.top:853
    - tls:1.1.1.1
    - tls:1.1.1.1:888
    - [2605:e440:2::3:272]:54
    - 194.58.44.150:54
    - 194.58.44.150


- **DNS-разрешение**:
  - Выполнять запросы только на A (IPv4) и AAAA (IPv6) записи.
  - Обязательная поддержка DoT и DoH для безопасного разрешения.
  - Выводить TTL для каждой записи как указано в ответе DNS-сервера.
  - Запросы выполняются только к одному DNS-серверу (указанному или по умолчанию).
  - Порт: Использовать по умолчанию для типа соединения (53 для UDP, 853 для DoT, 443 для DoH); если порт явно указан в аргументе, использовать его.

- **Геолокация IP**:
  - Для каждого полученного IP (IPv4/IPv6) определять онлайн через публичные API:
    - Сначала к IPInfo (используется `https://api.ipinfo.io/lite/<IP>?token=<KEY>`).
      - Берется `country_code`, `asn`, `as_name`.
    - Затем к IPGeolocation.io (используется `https://api.ipgeolocation.io/ipgeo?apiKey=<KEY>&ip=<IP>`).
      - Берется `country_code2` и `city`.
      - Город используется только если `country_code2` совпадает с кодом страны из IPInfo.
      - Если страны не совпадают, `city` = `N/A`.
    - Если IPInfo недоступен, используется код страны из IPGeolocation.
    - В таблице отображается ISO-код страны (например, `RU`), а не её название.
    - Утилита кэширует или корректно обрабатывает ошибки обоих API без прерывания вывода.
    - Основной API: IPGeolocation.io (бесплатный tier 30k запросов/мес, с API-ключом для free; эндпоинт https://api.ipgeolocation.io/ipgeo?apiKey=<KEY>&ip=<IP>; возвращает city на английском в поле "city", ASN в "asn", ASN-name в "organization"; поддержка IPv6). Обработка ошибок API (retry, пропуск с "N/A" для полей, но без пропуска IP-строки). IP всегда выводится, даже без геоданных (заполнять "N/A" в пустых полях). [1][3]

- **Вывод результатов**:
  - Формат: Таблица с колонками: TTL, IP, Country, ASN, ASN-Name, City.
  - Заголовок: "domain: <домен>\n nameserver: <сервер>:53" (или соответствующий порт).
  - Ширина колонки IP динамически подстраивается под IPv6.
  - Пример вывода для команды "doggi @8.8.8.8 ya.ru":
    ```
    domain: ya.ru
    nameserver: 8.8.8.8:53

    TTL    IP              Country  ASN       ASN-Name   City
    300    77.88.21.3      RU       AS13238   Yandex LLC Moscow
    300    77.88.26.26     RU       AS13238   Yandex LLC Moscow
    300    2a02:6b8::2:3   RU       AS13238   Yandex LLC Moscow
    ```
  - Если геоданные недоступны, заполнять "N/A" (не пропускать IP).
  - Обработка ошибок: Выводить понятные сообщения (например, "No records found", "Connection error" или "API limit exceeded").

#### 3. Технические требования
- **Язык и инструменты**:
  - Python 3.10+ (рекомендуется, с учетом Mac M3).
  - Зависимости:
    - `dnspython` для DNS-запросов (DoT/DoH).
    - `requests` для DoH и API-вызовов геолокации.
    - `tabulate` для форматированного вывода таблицы.
    - `click` или `argparse` для CLI-парсинга.
  - Установка: Через pip в виртуальном окружении (venv). Создать requirements.txt для установки (pip install -r requirements.txt). Скрипт с shebang `#!/usr/bin/env python3`.
  - Standalone: Опционально упаковать в бинарник с PyInstaller для запуска без Python.

- **Платформа**:
  - Только macOS (тестировать на M3 с 8 ГБ RAM; доступ к терминалу есть).

- **Безопасность и производительность**:
  - Онлайн API с rate limiting (IPGeolocation.io - 30k/мес; мониторить задержки, <50ms response).
  - Обработка IPv6 нативно.
  - Таймауты для DNS-запросов и API (5-10 сек).
  - Логирование ошибок в stderr, без хранения API-ключей (использовать env var для ключа IPGeolocation.io).

- **Установка и запуск**:
  - Команда: `python doggi.py @<сервер> <домен>` или после установки `doggi @<сервер> <домен>`.
  - Документация: Встроенная справка (`--help`).
  - Утилиту можно сделать глобально доступной как `doggi` через shebang и симлинк в `$PATH`.
  - Пример shebang: `#!/Users/michael7/env/doggi-env/bin/python`.
  - Пример установки: `ln -s /Users/michael7/env/doggi-env/doggi.py /usr/local/bin/doggi`.

#### 4. Нефункциональные требования
- **Производительность**: Разрешение < 2 сек на запрос (учитывая API-вызовы).
- **Тестирование**: Unit-тесты для DNS и геолокации (pytest) на Mac M3. Тест-кейсы: ya.ru, google.com, IPv6-домены; мок API-ответов (реальные запросы с доступом к терминалу).
- **Лицензия**: MIT (открытый код).
- **Разработка**: Модульный код (отдельные функции для DNS, geoip API, вывода).

#### 4.1 Дополнительные возможности
- Поддержка `alias` для быстрой работы (`alias doggi='/path/to/python /path/to/doggi.py'`).
- Возможность будущего расширения API (например, ipdata.co, DB-IP, MaxMind) с мультисурс-кросспроверкой.
- Опция перехода на платный API IPInfo для получения города напрямую (endpoint `https://api.ipinfo.io/<IP>?token=<KEY>`).

#### 5. Примеры использования
- По умолчанию: `doggi ya.ru` (использует tls://1.1.1.1).
- С сервером: `doggi @8.8.8.8 example.com`.
- DoH: `doggi @https://dns.google/resolve ya.ru`.

#### 6. Критерии приемки
- Утилита запускается на Mac без ошибок.
- Правильно разрешает домены с DoT/DoH (только A/AAAA, один сервер).
- Таблица выводится корректно, геоданные (включая city на английском и ASN) точны на основе IPGeolocation.io (N/A для недоступных полей, без пропуска IP).
- Обработка edge-кейсов: Нет IP, неверный сервер, IPv6-only, API-ошибки.
- Формат таблицы сохраняет выравнивание для IPv6 (автоматическая адаптация ширины колонки IP).

Sources
[1] Free IP Geolocation API and Accurate IP Geolocation Database https://ipgeolocation.io
[2] Top 8 Best IP Geolocation APIs (Updated for 2025) https://www.abstractapi.com/guides/ip-geolocation/best-ip-geolocation-apis
[3] Best IP Geolocation API and IP API for Accurate IP Lookup https://ipgeolocation.io/ip-location-api.html
